some code and ideas comes from http://blog.csdn.net/xiao__gui/article/details/50041673

